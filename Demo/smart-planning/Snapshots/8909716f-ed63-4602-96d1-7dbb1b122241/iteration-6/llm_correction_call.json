{
  "request": {
    "model": "gpt-4o-mini",
    "temperature": 0.3,
    "messages": [
      {
        "role": "system",
        "content": "You are a precise data correction expert. Always respond with valid JSON."
      },
      {
        "role": "user",
        "content": "You are a data correction expert for Smart Planning API snapshots.\n\nINPUT DATA EXPLANATION:\n1. VALIDATION FIX RULES: Mandatory correction strategies for different error types. Follow these rules exactly.\n2. ORIGINAL ERROR: Raw validation message from the Smart Planning API validator showing what failed.\n3. ERROR ANALYSIS: Interpreted error type and search parameters from the analysis tool.\n4. SEARCH RESULTS: Located error with enriched context containing:\n   - enriched_context.field_examples: Valid values for reference (use to understand correct formats)\n   - enriched_context.format_patterns: Detected ID patterns with statistics (use to generate new IDs)\n   - enriched_context.related_entities: Similar entries and all valid IDs (use to find gaps or duplicates)\n\nHOW TO USE THE DATA:\n- Check field_examples to see what valid values look like\n- Use format_patterns to detect ID naming conventions (prefix, separators, length)\n- Use related_entities to find missing sequence numbers or similar entries\n- Follow the pattern exactly when generating new values\n\n---\n\nVALIDATION FIX RULES:\n# Validation Fix Rules\n\n## 1. Duplizierte IDs (validate_unique_ids-duplicate)\n\n**Problem:** Mehrere Eintr채ge haben dieselbe ID.\n\n**Strategie:** Nummeriere Duplikate mit `_2`, `_3`, etc.\n\n**Beispiel:**\n```json\n// Vorher\n\"articles\": [\n    {\"articleId\": \"SPE_AR_fil\"},\n    {\"articleId\": \"SPE_AR_fil\"}\n]\n\n// Nachher\n\"articles\": [\n    {\"articleId\": \"SPE_AR_fil\"},\n    {\"articleId\": \"SPE_AR_fil_2\"}\n]\n// oder\n\"articles\": [\n    {\"articleId\": \"SPE_AR_fil_2\"},\n    {\"articleId\": \"SPE_AR_fil\"}\n]\n```\n\n**Mit Referenzen:** Aktualisiere alle betroffenen Referenzen.\n```json\n// Vorher\n\"articles\": [{\"articleId\": \"ART_001\"}, {\"articleId\": \"ART_001\"}],\n\"demands\": [\n    {\"demandId\": \"D001\", \"articleId\": \"ART_001\"},\n    {\"demandId\": \"D002\", \"articleId\": \"ART_001\"}\n]\n\n// Nachher\n\"articles\": [{\"articleId\": \"ART_001\"}, {\"articleId\": \"ART_001_2\"}],\n\"demands\": [\n    {\"demandId\": \"D001\", \"articleId\": \"ART_001\"},\n    {\"demandId\": \"D002\", \"articleId\": \"ART_001_2\"}\n]\n```\n\n---\n\n## 2. Leere Pflichtfelder (validate_unique_ids-empty)\n\n**Problem:** ID-Feld ist leer (`null`, `\"\"`, oder nur Whitespace).\n\n**Strategie:** Generiere ID basierend auf erkanntem Pattern.\n\n**Pattern-Erkennung:**\n1. Analysiere existierende IDs im gleichen Array\n2. Erkenne Format (z.B. `PREFIX_{ARTIKEL}_{NUMMER}`)\n3. Finde fehlende Sequenznummer\n4. Generiere neue ID nach gleichem Pattern\n\n**Beispiel:**\n```json\n// Vorher - demandId fehlt\n\"demands\": [\n    {\"demandId\": \"DSPE_EM_001\", \"articleId\": \"SPE_EM\"},\n    {\"demandId\": \"\", \"articleId\": \"SPE_EM\"},\n    {\"demandId\": \"DSPE_EM_003\", \"articleId\": \"SPE_EM\"}\n]\n\n// Pattern erkannt: DSPE_{articleId}_{sequence}\n// Fehlende Nummer: 002\n\n// Nachher\n\"demands\": [\n    {\"demandId\": \"DSPE_EM_001\", \"articleId\": \"SPE_EM\"},\n    {\"demandId\": \"DSPE_EM_002\", \"articleId\": \"SPE_EM\"},\n    {\"demandId\": \"DSPE_EM_003\", \"articleId\": \"SPE_EM\"}\n]\n```\n\n**Fallback:** Wenn kein Pattern erkennbar, nutze `{PREFIX}_{TIMESTAMP}` oder `{PREFIX}_NEW_{INDEX}`.\n\n---\n\n## 3. Ung체ltige Referenzen (validate_references)\n\n**Problem:** Referenz-ID existiert nicht im referenzierten Array.\n\n**Strategie 1 - Referenz korrigieren:** Finde 채hnlichste existierende ID.\n```json\n// Vorher - \"SPE_AR\" existiert nicht in articles\n\"demands\": [{\"demandId\": \"D001\", \"articleId\": \"SPE_AR\"}],\n\"articles\": [{\"articleId\": \"SPE_AR_fil\"}]\n\n// Nachher\n\"demands\": [{\"demandId\": \"D001\", \"articleId\": \"SPE_AR_fil\"}],\n\"articles\": [{\"articleId\": \"SPE_AR_fil\"}]\n```\n\n**Strategie 2 - Eintrag erstellen:** Erstelle fehlenden Eintrag mit Minimal-Daten.\n```json\n// Vorher - Equipment \"EQ_999\" fehlt\n\"workPlans\": [{\n    \"workPlanId\": \"WP_001\",\n    \"steps\": [{\"equipmentId\": \"EQ_999\"}]\n}],\n\"equipment\": []\n\n// Nachher\n\"workPlans\": [{\n    \"workPlanId\": \"WP_001\",\n    \"steps\": [{\"equipmentId\": \"EQ_999\"}]\n}],\n\"equipment\": [{\"equipmentId\": \"EQ_999\"}]\n```\n\n**Priorisierung:** Strategie 1 (korrigieren) bevorzugen, wenn 채hnliche ID existiert. Sonst Strategie 2 (erstellen).\n\nORIGINAL ERROR:\n{\n  \"level\": \"ERROR\",\n  \"message\": \"[validate_unique_ids] Demand IDs must not be empty. Empty IDs found: .\"\n}\n\nERROR ANALYSIS:\n{\n  \"search_mode\": \"empty_field\",\n  \"search_value\": \"demandId\",\n  \"error_type\": \"Demand IDs must not be empty; empty IDs were found.\",\n  \"should_investigate\": true\n}\n\nSEARCH RESULTS (Error Context):\n{\n  \"snapshot_id\": \"8909716f-ed63-4602-96d1-7dbb1b122241\",\n  \"search_mode\": \"empty_field\",\n  \"search_value\": \"demandId\",\n  \"error_type\": \"EMPTY_FIELD\",\n  \"results_count\": 1,\n  \"original_structure\": [\n    {\n      \"demandId\": \"\",\n      \"articleId\": \"SPE_EM\",\n      \"quantity\": 1000,\n      \"packaging\": \"71164\",\n      \"successor\": \"01A11305414002000\",\n      \"vgnr-vorschlag\": null,\n      \"dueDate\": \"2025-11-20T00:00:00Z\",\n      \"dispatcherGroup\": \"20\",\n      \"priority\": 12\n    }\n  ],\n  \"results\": [\n    {\n      \"path\": \"demands[3].demandId\",\n      \"value\": \"\",\n      \"original_object\": {\n        \"demandId\": \"\",\n        \"articleId\": \"SPE_EM\",\n        \"quantity\": 1000,\n        \"packaging\": \"71164\",\n        \"successor\": \"01A11305414002000\",\n        \"vgnr-vorschlag\": null,\n        \"dueDate\": \"2025-11-20T00:00:00Z\",\n        \"dispatcherGroup\": \"20\",\n        \"priority\": 12\n      },\n      \"references\": {\n        \"successor_demands\": [],\n        \"predecessor_demands\": [],\n        \"customer_orders\": []\n      },\n      \"article_context\": {}\n    }\n  ],\n  \"context\": {\n    \"total_demands_count\": 15,\n    \"total_customer_orders\": 14,\n    \"validation_rules\": {\n      \"demandId_must_be_unique\": true,\n      \"successor_must_reference_valid_demand\": true\n    }\n  },\n  \"enriched_context\": {\n    \"field_examples\": {\n      \"demandId\": [\n        \"DSPE_AR_fil_001\",\n        \"DSPE_AR_fil_002\",\n        \"DSPE_EM_001\",\n        \"DSPE_EM_003\",\n        \"DSPE_GS_gr_001\",\n        \"DSPE_GS_kl_001\",\n        \"DSPE_PU_gr_001\",\n        \"DSPE_PU_gr_002\",\n        \"DSPE_PU_gr_003\",\n        \"DSPE_PU_gr_004\"\n      ],\n      \"articleId\": [\n        \"SPE_AR_fil\",\n        \"SPE_EM\",\n        \"SPE_GS_gr\",\n        \"SPE_GS_kl\",\n        \"SPE_PU_gr\",\n        \"SPE_PU_kl\",\n        \"SPE_ZU_gr\",\n        \"SPE_ZU_kl\"\n      ],\n      \"packaging\": [\n        \"70409\",\n        \"71164\",\n        \"70702\",\n        \"71105\",\n        \"71330\",\n        \"71611\"\n      ],\n      \"successor\": [\n        \"01A11305414001000\",\n        \"SPE_AR_fil  01\",\n        \"01A11305414002000\",\n        \"01A11305415001000\",\n        \"01A11305418001000\",\n        \"01A11305419001000\",\n        \"01A11305422001000\",\n        \"01A11305422002000\",\n        \"01A11305422003000\"\n      ],\n      \"dispatcherGroup\": [\n        \"20\",\n        \"10\"\n      ]\n    },\n    \"format_patterns\": {\n      \"demandId\": {\n        \"field_name\": \"demandId\",\n        \"total_count\": 15,\n        \"non_empty_count\": 14,\n        \"sample_values\": [\n          \"DSPE_AR_fil_001\",\n          \"DSPE_AR_fil_002\",\n          \"DSPE_EM_001\",\n          \"DSPE_EM_003\",\n          \"DSPE_GS_gr_001\"\n        ],\n        \"length_range\": {\n          \"min\": 11,\n          \"max\": 15\n        },\n        \"detected_patterns\": [\n          \"Starts with 'D'\",\n          \"Contains underscore separator\"\n        ]\n      }\n    },\n    \"related_entities\": {\n      \"demands_same_article\": [\n        {\n          \"demandId\": \"DSPE_EM_001\",\n          \"articleId\": \"SPE_EM\",\n          \"quantity\": 1000,\n          \"dueDate\": \"2025-11-20T00:00:00Z\"\n        },\n        {\n          \"demandId\": \"\",\n          \"articleId\": \"SPE_EM\",\n          \"quantity\": 1000,\n          \"dueDate\": \"2025-11-20T00:00:00Z\"\n        },\n        {\n          \"demandId\": \"DSPE_EM_003\",\n          \"articleId\": \"SPE_EM\",\n          \"quantity\": 500,\n          \"dueDate\": \"2025-11-20T00:00:00Z\"\n        }\n      ],\n      \"all_valid_demand_ids\": [\n        \"DSPE_AR_fil_001\",\n        \"DSPE_AR_fil_002\",\n        \"DSPE_EM_001\",\n        \"DSPE_EM_003\",\n        \"DSPE_GS_gr_001\",\n        \"DSPE_GS_kl_001\",\n        \"DSPE_PU_gr_001\",\n        \"DSPE_PU_gr_002\",\n        \"DSPE_PU_gr_003\",\n        \"DSPE_PU_gr_004\",\n        \"DSPE_PU_kl_001\",\n        \"DSPE_ZU_gr_001\",\n        \"DSPE_ZU_gr_002\",\n        \"DSPE_ZU_kl_001\"\n      ]\n    }\n  }\n}\n\n---\n\nTASK:\nAnalyze the error and generate a structured correction proposal following the fix rules.\n\nOUTPUT FORMAT (JSON):\n{\n  \"action\": \"update_field\",\n  \"target_path\": \"exact.path[index].field\",\n  \"current_value\": \"current value\",\n  \"new_value\": \"corrected value\",\n  \"reasoning\": \"Explanation of why this correction is proposed\",\n  \"additional_updates\": [\n    {\n      \"target_path\": \"path.to.reference\",\n      \"current_value\": \"old\",\n      \"new_value\": \"new\"\n    }\n  ]\n}\n"
      }
    ]
  },
  "response": {
    "content": {
      "action": "update_field",
      "target_path": "demands[3].demandId",
      "current_value": "",
      "new_value": "DSPE_EM_002",
      "reasoning": "The demandId field was empty, which is not allowed. Based on the existing demand IDs for the same article, the new ID 'DSPE_EM_002' follows the detected pattern and fills the gap in the sequence.",
      "additional_updates": []
    },
    "model": "gpt-4o-mini-2024-07-18",
    "usage": {
      "prompt_tokens": 2584,
      "completion_tokens": 101,
      "total_tokens": 2685
    }
  }
}