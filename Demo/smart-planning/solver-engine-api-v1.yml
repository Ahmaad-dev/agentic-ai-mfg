openapi: 3.0.0
info:
  title: DS Esarom Python Microservice Engine
  version: 1.13.1
  description: API for running the solver with provided snapshot data.
servers:
- url: http://localhost/api/v1
components:
  schemas:
    Article:
      type: object
      description: Represents an article used in production.
      required:
      - articleId
      - articleName
      - standardPackaging
      - workPlanId
      - workItemConfigs
      - relDensityMin
      - relDensityMax
      properties:
        articleId:
          type: string
          description: Unique identifier for the article.
          example: '100023'
        articleName:
          type: string
          description: Name of the article.
          example: Orangen-Emulsion
        standardPackaging:
          type: string
          description: Standard packaging for the article.
          example: '71105'
        workPlanId:
          type: string
          description: Identifier for the associated work plan.
          example: SP10        SP01
        relDensityMin:
          type: number
          format: float
          description: Minimum relative density value.
          example: 1.05
        relDensityMax:
          type: number
          format: float
          description: Maximum relative density value.
          example: 1.07
        minOptimalBatchSize:
          type: number
          format: float
          description: Minimum optimal batch size.
          example: 300.0
        maxOptimalBatchSize:
          type: number
          format: float
          description: Maximum optimal batch size.
          example: 5800.0
        hygieneImpactClass:
          type: number
          format: float
          description: Hygiene impact class.
          default: 50.0
          example: 50.0
        workItemConfigs:
          type: array
          items:
            $ref: '#/components/schemas/WorkItemConfig'
          description: Configuration for work items used in the production of this article.
          example:
          - workItemKey: VOAR01
            rampUpTime: 15.0
            netTimeFactor: 0.0
          - workItemKey: BA01
            rampUpTime: 30.0
            netTimeFactor: 1.0
            sequence: HPHPHas
          - workItemKey: RF01
            rampUpTime: 60.0
            netTimeFactor: 0.016
            sequence: R(24)F
        departmentId:
          type: string
          description: Identifier for the department.
          example: 20100
        departmentName:
          type: string
          description: Name of the department.
          example: AfG (Homo/Past)

    WorkItemConfig:
      type: object
      description: Configuration for a work item specific to an article
      required:
      - workItemKey
      - rampUpTime
      - netTimeFactor
      properties:
        workItemKey:
          type: string
          description: Identifier for the work item that matches workIitemKey in workplan steps
        rampUpTime:
          type: number
          format: float
          description: Ramp up time adjustment for this work item
        netTimeFactor:
          type: number
          format: float
          description: Time factor used for calculations
        sequence:
          type: string
          description: Sequence information representing operations to be performed.

    WorkPlan:
      type: object
      description: Represents a work plan detailing various production steps.
      required:
      - workPlanId
      - preparationAroma
      - preparationPowder
      - waitingTime1
      - manufacturing
      - restingFiltering1
      - qualityCheck1
      - waitingTime2
      - processing
      - restingFiltering2
      - qualityCheck2
      - waitingTime3
      - filling
      - waitingTime4
      properties:
        workPlanId:
          type: string
          description: Unique identifier for the work plan.
        workplanName:
          type: string
          description: Name of the work plan.
        preparationAroma:
          $ref: '#/components/schemas/ProcessStep'
          description: Preparation process for aroma components.
        preparationPowder:
          $ref: '#/components/schemas/ProcessStep'
          description: Preparation process for powder components.
        waitingTime1:
          $ref: '#/components/schemas/ProcessStep'
          description: First waiting period in the workflow.
        manufacturing:
          $ref: '#/components/schemas/ProcessStep'
          description: Manufacturing process step.
        restingFiltering1:
          $ref: '#/components/schemas/ProcessStep'
          description: First resting and filtering process.
        qualityCheck1:
          $ref: '#/components/schemas/ProcessStep'
          description: First quality check process.
        waitingTime2:
          $ref: '#/components/schemas/ProcessStep'
          description: Second waiting period in the workflow.
        processing:
          $ref: '#/components/schemas/ProcessStep'
          description: General processing step.
        restingFiltering2:
          $ref: '#/components/schemas/ProcessStep'
          description: Second resting and filtering process.
        qualityCheck2:
          $ref: '#/components/schemas/ProcessStep'
          description: Second quality check process.
        waitingTime3:
          $ref: '#/components/schemas/ProcessStep'
          description: Third waiting period in the workflow.
        filling:
          $ref: '#/components/schemas/ProcessStep'
          description: Filling process step.
        waitingTime4:
          $ref: '#/components/schemas/ProcessStep'
          description: Fourth waiting period in the workflow.

    Demand:
      type: object
      description: Represents a production demand.
      required:
      - demandId
      - quantity
      - dueDate
      - articleId
      properties:
        demandId:
          type: string
          description: Unique identifier for the demand.
          example: N05208423
        articleId:
          type: string
          description: Article number associated with the demand.
          example: '100023'
        quantity:
          type: number
          description: Quantity required.
          example: 5800.0
        packaging:
          type: string
          description: Packaging type.
          example: '71105'
        successor:
          type: string
          description: Successor demand identifier.
          example: 31A11294894001000
        dueDate:
          type: string
          format: date-time
          description: Due date for the demand.
          example: '2025-02-25T00:00:00Z'
        dispatcherGroup:
          type: string
          description: Dispatcher group for the demand.
          example: 01
        priority:
          type: integer
          description: Priority of the demand (optional).
          example:

    Equipment:
      type: object
      description: Represents equipment used in production.
      required:
      - equipmentId
      - equipmentKey
      - name
      - predecessors
      - batchSizeMin
      - batchSizeMax
      - functions
      - usageFactor
      - workItems
      properties:
        name:
          type: string
          description: Name of the equipment.
          example: Abfuellen Aromen 01
        equipmentId:
          type: string
          format: uuid
          description: Unique identifier for the equipment.
        equipmentKey:
          type: string
          description: ID used by ESAROM. Not unique, since ESAROM uses the same ID for identical equipment.
          example: MTO02
        predecessors:
          type: array
          items:
            type: string
          description: List of predecessor equipment.
          example:
          - MTO02
        throughput:
          type: number
          format: float
          description: Throughput of the equipment.
          example: 570.0
        batchSizeMin:
          type: number
          format: float
          description: Minimum batch size in liters (L).
          example: 0.0
        batchSizeMax:
          type: number
          format: float
          description: Maximum batch size in liters (L).
          example: 200.0
        functions:
          type: array
          items:
            type: string
          description: List of functions performed by the equipment.
          example:
          - Abfueller
        usageFactor:
          type: number
          format: float
          description: Factor representing human resource utilization required by the equipment.
          example: 1.0
        qualification:
          type: string
          description: Qualification required for operating the equipment.
          example: Aromen-Abf
        workItems:
          type: array
          items:
            type: string
          description: List of work items for which the equipment can be used.
          example:
          - ABF01
        wasteVolume:
          type: number
          format: float
          description: Wasted volume by equipment in liters.
          example: 20.0
        hygieneRelevant:
          type: boolean
          description: Whether cleaning should be considered or not.
          default: true
          example: true
        processingSequence:
          type: array
          items:
            type: string
          description: List of supported processing sequences for BA01 equipment (e.g., H=homogensieren, P=pasteurisieren, Has=homogenisieren aseptisch).
          example: [H, P, HP, PH, HH, HHP, HPH, PHH, PHas, HPHas, PHHas]

    EquipmentUnavailability:
      type: object
      description: Represents unavailability periods for equipment.
      required:
      - equipmentId
      - equipmentKey
      - unavailabilities
      properties:
        equipmentId:
          type: string
          format: uuid
          description: Unique identifier for the equipment instance.
        equipmentKey:
          type: string
          description: Alpha numeric identifier for the equipment.
        unavailabilities:
          type: array
          items:
            type: object
            description: List of unavailability periods.
            required:
            - start
            - end
            properties:
              start:
                type: string
                format: date-time
                description: Start datetime of the unavailability.
              end:
                type: string
                format: date-time
                description: End datetime of the unavailability.
              note:
                type: string
                description: Note of the unavailability.

    WorkerQualification:
      type: object
      description: Represents the qualifications of a worker.
      required:
      - worker
      properties:
        worker:
          type: object
          description: Details of the worker.
          required:
          - workerName
          - workerId
          properties:
            workerName:
              type: string
              description: Name of the worker.
            workerId:
              type: string
              description: Unique identifier for the worker.
        qualifications:
          type: array
          items:
            type: object
            description: List of qualifications of the worker.
            required:
            - qualification
            - category
            properties:
              qualification:
                type: string
                description: Qualification of the worker.
              category:
                type: string
                description: Category of the qualification.

    WorkerAvailability:
      type: object
      description: Represents the availability of a worker.
      required:
      - worker
      properties:
        worker:
          type: object
          description: Details of the worker.
          required:
          - workerId
          properties:
            workerId:
              type: string
              description: Unique identifier for the worker.
        availabilities:
          type: array
          items:
            type: object
            description: List of availabilities of the worker.
            required:
            - startDatetime
            - possibleOvertime
            properties:
              startDatetime:
                type: string
                format: date-time
                description: Start datetime of the availability.
              possibleOvertime:
                type: string
                description: Possible overtime duration.

    SolverConfig:
      type: object
      description: Configuration settings for the solver.
      properties:
        maxDemandsCount:
          type: integer
          default: 10
          description: Maximum number of demands to consider in the solver run.
        mergeProcessingPackagingIds:
          type: array
          items:
            type: string
          description: List of packaging IDs that require work items "BA01" and "ABF01" to be merged into a single "COMB" operation.

        latenessPenalty:
          type: number
          format: float
          description: Penalty for lateness.
        resourceUsage:
          type: number
          format: float
          description: Resource usage cost.
        transitionCosts:
          type: number
          format: float
          description: Costs for transitions between tasks.
        unplannedTasks:
          type: number
          format: float
          description: Penalty for unplanned tasks.
        poorPipingPenalty:
          type: number
          format: float
          description: Penalty for poor piping.

    WorkItem:
      type: object
      description: Represents a work item generated by the solver.
      required:
      - workItemId
      - description
      - workItemKey
      - articleId
      - batchSize
      properties:
        workItemId:
          type: string
          format: uuid
          description: Unique identifier for the work item.
        description:
          type: string
          description: Description of the work item (e.g., "prep_aroma", "quality_check1").
        startTime:
          type: string
          format: date-time
          description: Start time of the work item.
        endTime:
          type: string
          format: date-time
          description: End time of the work item.
        equipment:
          type: array
          items:
            type: string
          description: List of equipment IDs used for this work item.
        workItemKey:
          type: string
          description: Identifier for the work item, linking to the work plan template.
        workers:
          type: array
          description: List of workers assigned to this work item with their utilization
          items:
            type: object
            required:
            - workerId
            - workerUtilization
            properties:
              workerId:
                type: string
                description: Unique identifier of the assigned worker
              workerUtilization:
                type: number
                format: float
                description: Utilization factor of the worker for this work item (between 0 and 1)
        articleId:
          type: string
          description: Identifier for the article being processed.
        batchSize:
          type: number
          format: float
          description: The quantity processed in this work item (e.g., liters, units).
        predecessors:
          type: array
          items:
            type: string
          description: IDs of work items that must be completed before this work item can start

    UnmetDemand:
      type: object
      required:
      - demandId
      - reason
      properties:
        demandId:
          type: string
          description: The ID of the demand that could not be planned
        reason:
          type: string
          description: Human-readable explanation of why the demand could not be planned (in English)

    SolverMetrics:
      type: object
      description: Performance metrics from the solver engine.
      required:
      - totalCostFunctionValue
      - unmetDemands
      properties:
        totalCostFunctionValue:
          type: number
          format: float
          description: The total cost function value from the solver's objective function.
        unmetDemands:
          type: array
          items:
            $ref: '#/components/schemas/UnmetDemand'
          description: List of demands that could not be planned

    ProductionOrder:
      type: object
      description: Represents a production order generated from demands
      required:
      - productionOrderId
      - productionOrderName
      - demands
      - workItems
      properties:
        productionOrderId:
          type: string
          format: uuid
          description: Unique identifier for the production order
        productionOrderName:
          type: string
          description: Name of the production order, unique and avlid only within one solver run.
        demands:
          type: array
          items:
            type: string
          description: List of demand IDs included in this production order
        workItems:
          type: array
          items:
            type: string
          description: List of work item IDs that make up this production order

    SolverEngineResponse:
      type: object
      description: Complete response from the solver engine.
      required:
      - workItems
      - solverMetrics
      - productionOrders
      properties:
        workItems:
          type: array
          items:
            $ref: '#/components/schemas/WorkItem'
          description: Array of work items generated by the solver.
        solverMetrics:
          $ref: '#/components/schemas/SolverMetrics'
          description: Performance metrics from the solver run.
        productionOrders:
          type: array
          items:
            $ref: '#/components/schemas/ProductionOrder'
          description: Production orders generated from demands

    Snapshot:
      type: object
      description: Represents a snapshot of all data required to run the solver.
      properties:
        articles:
          type: array
          items:
            $ref: '#/components/schemas/Article'
          description: List of articles.
        workPlans:
          type: array
          items:
            $ref: '#/components/schemas/WorkPlan'
          description: List of work plans.
        demands:
          type: array
          items:
            $ref: '#/components/schemas/Demand'
          description: List of demands.
        equipment:
          type: array
          items:
            $ref: '#/components/schemas/Equipment'
          description: List of equipment.
        equipmentUnavailabilities:
          type: array
          items:
            $ref: '#/components/schemas/EquipmentUnavailability'
          description: List of equipment unavailability periods.
        workerQualifications:
          type: array
          items:
            $ref: '#/components/schemas/WorkerQualification'
          description: List of worker qualifications.
        workerAvailability:
          type: array
          items:
            $ref: '#/components/schemas/WorkerAvailability'
          description: List of worker availabilities.
        packagingEquipmentCompatibility:
          type: array
          items:
            $ref: '#/components/schemas/PackagingEquipmentCompatibility'
          description: List of packaging-equipment compatibility mappings.
        customerOrderPositions:
          type: array
          items:
            $ref: '#/components/schemas/CustomerOrderPosition'
          description: List of customer order positions.
        solverConfig:
          $ref: '#/components/schemas/SolverConfig'
          description: Configuration settings for the solver.

    CustomerOrderPosition:
      type: object
      description: Represents customer order positions.
      required:
      - customerOrderPositionId
      - demands
      - isDueDateConfirmed
      - dueDate
      properties:
        customerOrderPositionId:
          type: string
          format: uuid
          description: Unique identifier for the customer order position generated by smart planning.
        esaromOrderNumber:
          type: string
          description: Customer order position number by ESAROM.
        customerOrderNumber:
          type: string
          description: Customer order number by ESAROM.
        clerkNumber:
          type: string
          description: Clerk number.
        clerkName:
          type: string
          description: Clerk name.
        shippingMethod:
          type: string
          description: Shipping method.
        shippingMethodDescription:
          type: string
          description: Description of the shipping method.
        orderType:
          type: string
          description: Order type.
        customerNumber:
          type: string
          description: Customer number by ESAROM.
        customerName:
          type: string
          description: Customer name by ESAROM.
        demands:
          type: array
          items:
            type: string
          description: List of demand IDs included in this customer order position.
        isDueDateConfirmed:
          type: boolean
          description: Indicates if the due date is confirmed.
        dueDate:
          type: string
          format: date-time
          description: Due date for the customer order position. An unconfirmed date is a Kundenwunschtermin.

    PackagingEquipmentCompatibility:
      type: object
      description: Represents compatibility between packaging and equipment for filling.
      required:
      - packaging
      - predecessors
      properties:
        packaging:
          type: string
          description: Packaging identifier.
        predecessors:
          type: array
          items:
            type: string
          description: List of compatible predecessor equipment.

    ProcessStep:
      type: object
      description: Common schema for process steps in a work plan.
      required:
      - rampupTimeEquipment
      - rampupTimeWorker
      - netTimeEquipment
      - netTimeWorker
      - workItemKey
      - netTimeFormula
      properties:
        rampupTimeEquipment:
          type: number
          format: float
          description: Ramp-up time for equipment.
        rampupTimeWorker:
          type: number
          format: float
          description: Ramp-up time for worker.
        netTimeEquipment:
          type: number
          format: float
          description: Net operating time for equipment.
        netTimeWorker:
          type: number
          format: float
          description: Net operating time for worker.
        workItemKey:
          type: string
          description: Identifier for the work item.
        workItemDescription:
          type: string
          description: Description for the work item.
        netTimeFormula:
          type: string
          description: Formula for calculating net time (reserved for future use).

    ValidationMessage:
      type: object
      required:
      - level
      - message
      properties:
        level:
          type: string
          enum: [debug, info, warning, error]
          description: Severity level of the message
        message:
          type: string
          description: Detailed validation message

    ValidationResponse:
      type: object
      required:
      - validationMessages
      properties:
        validationMessages:
          type: array
          items:
            $ref: '#/components/schemas/ValidationMessage'
          description: Array of validation messages

    SnapshotValidationRequest:
      type: object
      required:
      - snapshot
      properties:
        snapshot:
          $ref: '#/components/schemas/Snapshot'
          description: The snapshot object to be validated
        verbosity:
          type: string
          enum: [debug, info, warning, error]
          default: info
          description: Verbosity level for validation messages (hierarchical)

paths:
  /run-solver:
    post:
      summary: Run the solver with provided snapshot data
      operationId: run_solver
      tags:
      - SolverV1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Snapshot'
      responses:
        '200':
          description: Response from the solver engine containing scheduled work items and performance metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SolverEngineResponse'
        '422':
          description: Schema validation errors (FastAPI default format)
          content:
            application/json:
              schema:
                type: object
                properties:
                  detail:
                    type: array
                    items:
                      type: object
        '460':
          description: Article not found error
        '461':
          description: Work plan not found error
        '462':
          description: Invalid work plan error
        '463':
          description: Snapshot validation error
        '560':
          description: Work operation validation error
        '561':
          description: Solver error
        '562':
          description: No solution found error
        '563':
          description: Optimizer error
        '564':
          description: Solver did not produce a valid result (e.g., infeasible, unbounded, invalid model)
        '500':
          description: Internal server error
  /validate-snapshot:
    post:
      summary: Validate snapshot data without running the solver
      operationId: validate_snapshot
      tags:
      - SolverV1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SnapshotValidationRequest'
      responses:
        '200':
          description: Successful validation with optional warnings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationResponse'
        '422':
          description: Schema validation errors (FastAPI default format)
          content:
            application/json:
              schema:
                type: object
                properties:
                  detail:
                    type: array
                    items:
                      type: object
        '260':
          description: Business validation errors
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationResponse'
        '500':
          description: Internal server error
